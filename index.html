<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>青蜂侠</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="青蜂侠">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="青蜂侠">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="青蜂侠">
<meta name="twitter:description">
  
    <link rel="alternate" href="/feed" title="青蜂侠" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">青蜂侠</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/feed" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Scrum中大项目管理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/bigproj-in-scrum/" class="article-date">
  <time datetime="2016-06-02T13:23:00.000Z" itemprop="datePublished">2016-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/bigproj-in-scrum/">Scrum中大项目管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>团队使用<a href="https://zh.wikipedia.org/wiki/Scrum" target="_blank" rel="external">Scrum</a> 已经有半年多了, 基本形成了一周一个迭代周期的正常开发节奏，团队的开发状态也进入了正规；但是在Scrum的迭代中，时常会出现一些比较大项目需求，这种大项目工期长，时常会跨团队/部门配合，因此在迭代中会出现很多问题，难以管理。</p>
<p>这篇文章是我们团队在周会上专门讨论大项目管理时的总结。</p>
<h3 id="1-Scrum迭代管理"><a href="#1-Scrum迭代管理" class="headerlink" title="1. Scrum迭代管理"></a>1. Scrum迭代管理</h3><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/scrum%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86.png" alt=""></p>
<p>在Scrum迭代中有是哪个重要的节点：</p>
<ul>
<li><p>Sprint需求会</p>
<p>在需求会上，主要是产品经理（PO）向技术团队阐述产品功能，在这个过程中开发人员会参与到产品细节的讨论中；这个讨论过程不仅能让开发更深入的理解产品的意义和细节，同时也可以提出自己对产品不同的见解，也可以直接挑战PO。最终会完成Story评审，对Stroy进行估点（评定Point），对各个Story确定优先级。需求会一般持续一个半小时以内。</p>
</li>
<li><p>Sprint计划会</p>
<p>计划会（planning）上会review一下上个迭代遗留下来的story和task，评估剩余的时间；之后会评估在需求会上评审通过的story，划分task，给出实现所需时间。之后每个人会主动领取task。目前我们每个迭代按照每天6小时计算开发时间，剩余的时间作为运营时间。</p>
</li>
</ul>
<ul>
<li><p>产品交付</p>
<p>对应系统功能就是功能上线，最终交付给PO。</p>
</li>
</ul>
<h3 id="2-大项目管理"><a href="#2-大项目管理" class="headerlink" title="2. 大项目管理"></a>2. 大项目管理</h3><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E5%A4%A7%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86.png" alt=""></p>
<p>大项目具有以下特点：</p>
<ul>
<li>功能复杂，需要有技术设计来厘清</li>
<li>开发量大，项目工期长；</li>
<li>Story难以拆小，或者拆小之后的Story没有意义；</li>
<li>可能跨团队/部门的合作。</li>
</ul>
<p>针对需要跨团队/部门合作的大项目，因为其他团队/部门的开发并不一定使用Scrum的迭代管理方式，即使他们使用相同的Scrum迭代周期，所以针对这种大项目更适合是使用瀑布式管理方式。大项目管理主要做好一下几个关键点，在实施过程中也就不会出现大的问题：</p>
<ul>
<li><p>需求评审</p>
<p>大项目说明需求本身就很大，因此在需求评审阶段把控好需求的方向和细节，包括需求内容和背景、确定干系方、初步技术可行性聘雇和初步的分线评估。</p>
</li>
<li><p>技术设计</p>
</li>
<li><p>分工排期</p>
<p>这个分工排期需要确定各个干系方的分工，每个干系方不同阶段的时间节点，包括PO需要提供到的物料（交互、视觉设计等），必要的情况下，需要干系方定期召开例会以同步进度和问题。</p>
</li>
<li><p>上线方案和时间点</p>
<p>大项目时常涉及到的较多的项目修改，需要做好上线方案和回滚方案的评审。上线方案需要确定需要上线的项目、配置、数据表（库）及其他运维项，这个上线方案需要分步骤验证，避免出现上线步骤接口或功能的兼容性问题；回滚方案是针对上线过程中一单某个步骤出现问题该如何回滚，也需要针对回滚方案分步骤验证。</p>
</li>
</ul>
<h3 id="3-Scrum中的大项目管理"><a href="#3-Scrum中的大项目管理" class="headerlink" title="3. Scrum中的大项目管理"></a>3. Scrum中的大项目管理</h3><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/scrum%E4%B8%AD%E7%AE%A1%E7%90%86%E5%A4%A7%E9%A1%B9%E7%9B%AE.png" alt=""></p>
<p>大项目放在Scrum中管理，有种把大象放到冰箱里，不过这次的步骤却不是打开冰箱把大象放进去。不过大项目可以借助Scrum中迭代的方式进行管理。</p>
<ul>
<li>需求评审放在Scrum迭代需求评审会上进行</li>
<li>Scrum计划会上划分task，如技术评审task，与其他团队/部门沟通task，开发task，测试task和上线task等。</li>
<li>在每个迭代计划会上，同样会review大项目的task，评估剩余时间，只不过大项目与其他团队/部门是有时间节点的，如果剩余时间超过预期，就需要评估风险并适度增加人力。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/bigproj-in-scrum/" data-id="cipak1vpz000fy95nxsg0d11o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrum-敏捷-大项目管理/">scrum 敏捷 大项目管理</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java中使用动态代码" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/dynamic-code-in-java/" class="article-date">
  <time datetime="2016-05-25T13:50:00.000Z" itemprop="datePublished">2016-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/dynamic-code-in-java/">Java中使用动态代码</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>O2O互联网的运营开发最大的特点就是每次运营活动规则千奇百怪，需要有许多个性化的配置，如何例A活动需要针对新用户做发红包的活动，B活动针对全部用户做发红包活动，而在B活动中针对新用户发x面额的红包，而针对老用户发y面值的红包。两个活动规则差别较大，如果每次都个性化开发，会非常浪费时间，因此如何支持规则的动态配置是个很大的挑战。</p>
<p>Java不是解决动态层问题的理想语言，这些动态层问题包括原型设计、脚本处理等。</p>
<p>公司的项目主要基于Java平台，在实践中发现主要有两种方式可以实现：</p>
<ul>
<li>统一表达式语言</li>
<li>动态语言，如Groovy</li>
</ul>
<h3 id="JUEL-Java-统一表达式语言"><a href="#JUEL-Java-统一表达式语言" class="headerlink" title="JUEL(Java 统一表达式语言)"></a>JUEL(Java 统一表达式语言)</h3><p>Java<strong>统一表达式语言</strong>（英语：Unified Expression Language，简称<strong>JUEL</strong>）是一种特殊用途的编程语言，主要在<a href="https://zh.wikipedia.org/wiki/Java" target="_blank" rel="external">Java</a> <a href="https://zh.wikipedia.org/wiki/Web%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F" target="_blank" rel="external">Web应用程序</a>用于将表达式嵌入到web页面。<a href="https://zh.wikipedia.org/wiki/Java" target="_blank" rel="external">Java</a>规范制定者和Java Web领域技术专家小组制定了统一的表达式语言。JUEL最初包含在<a href="https://zh.wikipedia.org/wiki/JSP" target="_blank" rel="external">JSP</a> 2.1规范JSR-245中，后来成为Java EE 7的一部分，改在JSR-341中定义。</p>
<p>主要的开源实现有：<a href="https://commons.apache.org/proper/commons-ognl/" target="_blank" rel="external">OGNL</a> ，<a href="http://java-source.net/open-source/expression-languages/mvel" target="_blank" rel="external">MVEL</a> ，<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_blank" rel="external">SpEL</a> ,<a href="http://java-source.net/open-source/expression-languages/juel" target="_blank" rel="external">JUEL</a> ,<a href="http://java-source.net/open-source/expression-languages/java-expression-language" target="_blank" rel="external">Java Expression Language (JEXL)</a> ,<a href="http://java-source.net/open-source/expression-languages/jeval" target="_blank" rel="external">JEval</a> ,<a href="http://java-source.net/open-source/expression-languages/jakarta-jxpath" target="_blank" rel="external">Jakarta JXPath</a> 等。这里主要介绍在实践中使用较多的MVEL、OGNL和SpEL。</p>
<h4 id="OGNL-Object-Graph-Navigation-Library"><a href="#OGNL-Object-Graph-Navigation-Library" class="headerlink" title="OGNL(Object Graph Navigation Library)"></a>OGNL(Object Graph Navigation Library)</h4><p>在Struts 2 的标签库中都是使用OGNL表达式访问ApplicationContext中的对象数据，OGNL主要有三个重要因素：</p>
<ul>
<li>Expression</li>
</ul>
<p>　Expression是整个OGNL的核心内容，所有的OGNL操作都是针对表达式解析后进行的。通过Expression来告知OGNL操作到底要干些什么。因此，Expression其实是一个带有语法含义的字符串，整个字符串将规定操作的类型和内容。OGNL表达式支持大量Expression，如“链式访问对象”、表达式计算、甚至还支持Lambda表达式。</p>
<ul>
<li>Root对象：</li>
</ul>
<p>　　　　OGNL的Root对象可以理解为OGNL的操作对象。当我们指定了一个表达式的时候，我们需要指定这个表达式针对的是哪个具体的对象。而这个具体的对象就是Root对象，这就意味着，如果有一个OGNL表达式，那么我们需要针对Root对象来进行OGNL表达式的计算并且返回结果。</p>
<ul>
<li>ApplicationContext</li>
</ul>
<p>有个Root对象和Expression，我们就可以使用OGNL进行简单的操作了，如对Root对象的赋值与取值操作。但是，实际上在OGNL的内部，所有的操作都会在一个特定的数据环境中运行。这个数据环境就是ApplicationContext（上下文环境）。OGNL的上下文环境是一个Map结构，称之为OgnlContext。Root对象也会被添加到上下文环境当中去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line">Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">context.put(<span class="string">"foo"</span>,foo);</span><br><span class="line">String expression = <span class="string">"foo.name == 'test'"</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Boolean result = (Boolean) Ognl.getValue(expression,context);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (OgnlException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码就是判断对象foo的name属性是否为test。</p>
<p>OGNL的具体语法参见<a href="https://commons.apache.org/proper/commons-ognl/language-guide.html" target="_blank" rel="external">OGNL language guide</a> 。</p>
<h4 id="MVEL"><a href="#MVEL" class="headerlink" title="MVEL"></a><a href="https://github.com/mvel/mvel" target="_blank" rel="external">MVEL</a></h4><p>MVEL最初作为Mike Brock创建的 Valhalla项目的表达式计算器（expression evaluator）。Valhalla本身是一个早期的类似 Seam 的“开箱即用”的Web 应用框架，而 Valhalla 项目现在处于休眠状态， MVEL则成为一个继续积极发展的项目。相比最初的OGNL、JEXL和JUEL等项目，而它具有远超它们的性能、功能和易用性 - 特别是集成方面。它不会尝试另一种JVM语言，而是着重解决嵌入式脚本的问题。</p>
<p>MVEL特别适用于受限环境 – 诸如由于内存或沙箱（sand-boxing）问题不能使用字节码生成。它不是试图重新发明Java，而是旨在提供一种Java程序员熟悉的语法，同时还加入了简短的表达式语法。</p>
<p>MVEL主要使用在Drools，是<a href="http://www.jboss.org/drools/" target="_blank" rel="external">Drools规则引擎</a>不可分割的一部分。</p>
<p>MVEL语法较为丰富，不仅包含了基本的属性表达式，布尔表达式，变量复制和方法调用，还支持函数定义，详情参见<a href="https://en.wikisource.org/wiki/MVEL_Language_Guide" target="_blank" rel="external">MVEL Language Guide</a> 。</p>
<p>MVEL在执行语言时主要有解释模式（<strong>Interpreted Mode</strong>）和编译模式（<strong>Compiled Mode</strong> ）两种：</p>
<ul>
<li>解释模式（Interpreted Mode）是一个无状态的，动态解释执行，不需要负载表达式就可以执行相应的脚本。</li>
<li>编译模式（Compiled Mode）需要在缓存中产生一个完全规范化表达式之后再执行。</li>
</ul>
<p>解释模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解释模式</span></span><br><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line">Map context = <span class="keyword">new</span> HashMap();</span><br><span class="line">String expression = <span class="string">"foo.name == 'test'"</span>;</span><br><span class="line">VariableResolverFactory functionFactory = <span class="keyword">new</span> MapVariableResolverFactory(context);</span><br><span class="line">context.put(<span class="string">"foo"</span>,foo);</span><br><span class="line">Boolean result = (Boolean) MVEL.eval(expression,functionFactory);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure>
<p>编译模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编译模式</span></span><br><span class="line">Foo foo = <span class="keyword">new</span> Foo();foo.setName(<span class="string">"test"</span>);Map context = <span class="keyword">new</span> HashMap();String expression = <span class="string">"foo.name == 'test'"</span>;VariableResolverFactory functionFactory = <span class="keyword">new</span> MapVariableResolverFactory(context);context.put(<span class="string">"foo"</span>,foo);</span><br><span class="line">Serializable compileExpression = MVEL.compileExpression(expression);</span><br><span class="line">Boolean result = (Boolean) MVEL.executeExpression(compileExpression, context, functionFactory);</span><br></pre></td></tr></table></figure>
<h4 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/expressions.html" target="_blank" rel="external">SpEL</a></h4><p>SpEl(Spring表达式语言）是一个支持查询和操作运行时对象导航图功能的强大的表达式语言。 它的语法类似于传统EL，但提供额外的功能，最出色的就是函数调用和简单字符串的模板函数。SpEL类似于Struts2x中使用的OGNL表达式语言，能在运行时构建复杂表达式、存取对象图属性、对象方法调用等等，并且能与Spring功能完美整合，如能用来配置Bean定义。</p>
<p>SpEL主要提供基本表达式、类相关表达式及集合相关表达式等，详细参见<a href="http://spring.cndocs.tk/expressions.html" target="_blank" rel="external">Spring 表达式语言 (SpEL)</a> 。</p>
<p>类似与OGNL，SpEL具有expression(表达式)，Parser（解析器），EvaluationContext(上下文）等基本概念；类似与MVEL，SpEl也提供了解释模式和编译模式两种运行模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解释器模式</span></span><br><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line"><span class="comment">// Turn on:</span></span><br><span class="line"><span class="comment">// - auto null reference initialization</span></span><br><span class="line"><span class="comment">// - auto collection growing</span></span><br><span class="line">SpelParserConfiguration config = <span class="keyword">new</span> SpelParserConfiguration(<span class="keyword">true</span>,<span class="keyword">true</span>);</span><br><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line">String expressionStr = <span class="string">"#foo.name == 'test'"</span>;</span><br><span class="line">StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.setVariable(<span class="string">"foo"</span>,foo);</span><br><span class="line">Expression expression = parser.parseExpression(expressionStr);</span><br><span class="line">Boolean result = expression.getValue(context,Boolean.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//编译模式</span></span><br><span class="line">config = <span class="keyword">new</span> SpelParserConfiguration(SpelCompilerMode.IMMEDIATE, RunSpel.class.getClassLoader());</span><br><span class="line">parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line">context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">context.setVariable(<span class="string">"foo"</span>,foo);</span><br><span class="line">expression = parser.parseExpression(expressionStr);</span><br><span class="line">result = expression.getValue(context,Boolean.class);</span><br></pre></td></tr></table></figure>
<h3 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a><a href="http://www.groovy-lang.org/" target="_blank" rel="external">Groovy</a></h3><p>Groovy除了<a href="http://gradle.org/" target="_blank" rel="external">Gradle</a> 上的广泛应用之外，另一个大范围的使用应该就是结合Java使用动态代码了。Groovy的语法与Java非常相似，以至于多数的Java代码也是正确的Groovy代码。Groovy代码动态的被<a href="https://zh.wikipedia.org/wiki/%E7%BC%96%E8%AF%91%E5%99%A8" target="_blank" rel="external">编译器</a>转换成Java字节码。由于其运行在JVM上的特性，Groovy可以使用其他Java语言编写的库。</p>
<p>Groovy可以看作给Java静态世界补充动态能力的语言，同时Groovy已经实现了java不具备的语言特性：</p>
<ul>
<li>函数字面值；</li>
<li>对集合的一等支持；</li>
<li>对正则表达式的一等支持；</li>
<li>对xml的一等支持；</li>
</ul>
<p>Groovy作为基于JVM的语言，与表达式语言存在语言级的不同，因此在语法上比表达还是语言更灵活。Java在调用Groovy时，都需要将Groovy代码编译成Class文件。</p>
<p>Groovy 可以采用GroovyClassLoader、GroovyShell、GroovyScriptEngine和<a href="http://docs.oracle.com/javase/6/docs/technotes/guides/scripting/" target="_blank" rel="external">JSR223</a> 等方式与Java语言集成。</p>
<h4 id="GroovyClassLoader"><a href="#GroovyClassLoader" class="headerlink" title="GroovyClassLoader"></a>GroovyClassLoader</h4><p> GroovyClassLoader是一个定制的类装载器，负责解释加载Java类中用到的Groovy类，也可以编译，Java代码可通过其动态加载Groovy脚本并执行。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooCompare</span>&#123;</span></span><br><span class="line">    <span class="keyword">boolean</span> compare(String toCompare)&#123;</span><br><span class="line">        Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">        foo.name = <span class="string">"test"</span>;</span><br><span class="line">        <span class="keyword">return</span> foo.name == toCompare;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GroovyClassLoader loader = <span class="keyword">new</span> GroovyClassLoader();</span><br><span class="line">Class groovyClass = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	String path = <span class="string">"FooCompare.groovy"</span>;</span><br><span class="line">    groovyClass = loader.parseClass(<span class="keyword">new</span> File(path));</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">GroovyObject groovyObject = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    groovyObject = (GroovyObject) groovyClass.newInstance();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">result = groovyObject.invokeMethod(<span class="string">"compare"</span>, <span class="string">"test"</span>);</span><br><span class="line"><span class="keyword">assert</span> result.equals(Boolean.TRUE);</span><br><span class="line">System.out.print(result);</span><br></pre></td></tr></table></figure>
<h4 id="GroovyShell"><a href="#GroovyShell" class="headerlink" title="GroovyShell"></a>GroovyShell</h4><p>GroovyShell允许在Java类中（甚至Groovy类）求任意Groovy表达式的值。可以使用Binding对象输入参数给表达式，并最终通过GroovyShell返回Groovy表达式的计算结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line">Binding binding = <span class="keyword">new</span> Binding();</span><br><span class="line">binding.setVariable(<span class="string">"foo"</span>,foo);</span><br><span class="line">GroovyShell shell = <span class="keyword">new</span> GroovyShell(binding);</span><br><span class="line">String expression = <span class="string">"foo.name=='test'"</span>;</span><br><span class="line">Object result = shell.evaluate(expression);</span><br><span class="line"><span class="keyword">assert</span> result.equals(Boolean.TRUE);</span><br></pre></td></tr></table></figure>
<h4 id="GroovyScriptEngine"><a href="#GroovyScriptEngine" class="headerlink" title="GroovyScriptEngine"></a>GroovyScriptEngine</h4><p>GroovyShell多用于推求对立的脚本或表达式，如果换成相互关联的多个脚本，使用GroovyScriptEngine会更好些。GroovyScriptEngine从您指定的位置（文件系统，URL，数据库，等等）加载Groovy脚本，并且随着脚本变化而重新加载它们。如同GroovyShell一样，GroovyScriptEngine也允许您传入参数值，并能返回脚本的值。</p>
<p>FooScript.groovy</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> blog.brucefeng.info.groovy</span><br><span class="line"></span><br><span class="line">foo.name==<span class="string">"test"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line">Binding binding = <span class="keyword">new</span> Binding();</span><br><span class="line">binding.setVariable(<span class="string">"foo"</span>,foo);</span><br><span class="line">String[] paths = &#123;<span class="string">"/demopath/"</span>&#125;</span><br><span class="line">GroovyScriptEngine gse = <span class="keyword">new</span> GroovyScriptEngine(paths);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    result = gse.run(<span class="string">"FooScript.groovy"</span>, binding);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ResourceException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (ScriptException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> result.equals(Boolean.TRUE);</span><br></pre></td></tr></table></figure>
<h4 id="JSR223"><a href="#JSR223" class="headerlink" title="JSR223"></a>JSR223</h4><p>JSR223 是Java 6提供的一种从Java内部执行脚本编写语言的方便、标准的方式，并提供从脚本内部访问Java 资源和类的功能，可以使用其运行多种脚本语言如JavaScript和Groovy等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setName(<span class="string">"test"</span>);</span><br><span class="line">ScriptEngineManager factory = <span class="keyword">new</span> ScriptEngineManager();</span><br><span class="line">ScriptEngine engine1 = factory.getEngineByName(<span class="string">"groovy"</span>);</span><br><span class="line">engine1.put(<span class="string">"foo"</span>,foo);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   result =  engine1.eval(expression);</span><br><span class="line">&#125; <span class="keyword">catch</span> (javax.script.ScriptException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> result.equals(Boolean.TRUE);</span><br></pre></td></tr></table></figure>
<h4 id="使用中经常出现的问题"><a href="#使用中经常出现的问题" class="headerlink" title="使用中经常出现的问题"></a>使用中经常出现的问题</h4><p>因此Java每次调用Groovy代码都会将Groovy编译成Class文件，因此在调用过程中会出现JVM级别的问题。如使用GroovyShell的parse方法导致perm区爆满的问题，使用GroovyClassLoader加载机制导致频繁gc问题和CodeCache用满，导致JIT禁用问题等，相关问题可以参考<a href="https://yq.aliyun.com/articles/2357" target="_blank" rel="external">Groovy与Java集成常见的坑</a> 。 </p>
<h3 id="性能对比"><a href="#性能对比" class="headerlink" title="性能对比"></a>性能对比</h3><hr>
<p>在这里简单对上面介绍到的OGNL、MVEL、SpEL和Groovy2.4 的性能进行大致的性能测试（简单测试）：</p>
<table>
<thead>
<tr>
<th>实现方式</th>
<th>耗时（ms)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Java</td>
<td>13</td>
</tr>
<tr>
<td>OGNL</td>
<td>2958</td>
</tr>
<tr>
<td>MVEL</td>
<td>225</td>
</tr>
<tr>
<td>SpEL</td>
<td>1023</td>
</tr>
<tr>
<td>Groovy</td>
<td>99</td>
</tr>
</tbody>
</table>
<p>通过这个简单测试发现，Groovy 2.4的性能已经足够的好，而MVEL的性能依然保持强劲，不过已经远远落后与Groovy，在对性能有一定要求的场景下已经不建议使用OGNL和SpEL。<br><strong>不过动态代码的执行效率还是远低于Java，因此在高性能的场景下慎用。</strong></p>
<p>以下是测试代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> blog.brucefeng.info.performance</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GroovyCal</span>&#123;</span></span><br><span class="line">    Integer cal(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> z)&#123;</span><br><span class="line">        <span class="keyword">return</span> x + y*<span class="number">2</span> - z;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> blog.brucefeng.info.performance;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunPerform</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> xmax = <span class="number">100</span>,ymax = <span class="number">100</span>,zmax= <span class="number">10</span>;</span><br><span class="line">            runJava(xmax, ymax, zmax);</span><br><span class="line">            runOgnl(xmax, ymax, zmax);</span><br><span class="line">            runMvel(xmax, ymax, zmax);</span><br><span class="line">            runSpel(xmax, ymax, zmax);</span><br><span class="line">            runGroovyClass(xmax, ymax, zmax);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runJava</span><span class="params">(<span class="keyword">int</span> xmax, <span class="keyword">int</span> ymax, <span class="keyword">int</span> zmax)</span> </span>&#123;</span><br><span class="line">        Date start = <span class="keyword">new</span> Date();</span><br><span class="line">        Integer result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xval = <span class="number">0</span>; xval &lt; xmax; xval++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> yval = <span class="number">0</span>; yval &lt; ymax; yval++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> zval = <span class="number">0</span>; zval &lt;= zmax; zval++) &#123;</span><br><span class="line">                    result += xval + yval * <span class="number">2</span> - zval;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Date end = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"time is : "</span> + (end.getTime() - start.getTime()) + <span class="string">",result is "</span> + result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runOgnl</span><span class="params">(<span class="keyword">int</span> xmax, <span class="keyword">int</span> ymax, <span class="keyword">int</span> zmax)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">        String expression = <span class="string">"x + y*2 - z"</span>;</span><br><span class="line">        Map&lt;String, Object&gt; context = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        Integer result = <span class="number">0</span>;</span><br><span class="line">        Date start = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xval = <span class="number">0</span>; xval &lt; xmax; xval++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> yval = <span class="number">0</span>; yval &lt; ymax; yval++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> zval = <span class="number">0</span>; zval &lt;= zmax; zval++) &#123;</span><br><span class="line">                    context.put(<span class="string">"x"</span>, xval);</span><br><span class="line">                    context.put(<span class="string">"y"</span>, yval);</span><br><span class="line">                    context.put(<span class="string">"z"</span>, zval);</span><br><span class="line">                    Integer cal = (Integer) Ognl.getValue(expression, context);</span><br><span class="line">                    result += cal;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Date end = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"Ognl:time is : "</span> + (end.getTime() - start.getTime()) + <span class="string">",result is "</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runMvel</span><span class="params">(<span class="keyword">int</span> xmax, <span class="keyword">int</span> ymax, <span class="keyword">int</span> zmax)</span> </span>&#123;</span><br><span class="line">        Map context = <span class="keyword">new</span> HashMap();</span><br><span class="line">        String expression = <span class="string">"x + y*2 - z"</span>;</span><br><span class="line">        Serializable compileExpression = MVEL.compileExpression(expression);</span><br><span class="line">        Integer result = <span class="number">0</span>;</span><br><span class="line">        Date start = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xval = <span class="number">0</span>; xval &lt; xmax; xval++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> yval = <span class="number">0</span>; yval &lt; ymax; yval++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> zval = <span class="number">0</span>; zval &lt;= zmax; zval++) &#123;</span><br><span class="line">                    context.put(<span class="string">"x"</span>, xval);</span><br><span class="line">                    context.put(<span class="string">"y"</span>, yval);</span><br><span class="line">                    context.put(<span class="string">"z"</span>, zval);</span><br><span class="line">                    VariableResolverFactory functionFactory = <span class="keyword">new</span> MapVariableResolverFactory(context);</span><br><span class="line">                    Integer cal = (Integer) MVEL.executeExpression(compileExpression, context, functionFactory);</span><br><span class="line">                    result += cal;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Date end = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"MVEL:time is : "</span> + (end.getTime() - start.getTime()) + <span class="string">",result is "</span> + result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSpel</span><span class="params">(<span class="keyword">int</span> xmax, <span class="keyword">int</span> ymax, <span class="keyword">int</span> zmax)</span> </span>&#123;</span><br><span class="line">        SpelParserConfiguration config;</span><br><span class="line">        ExpressionParser parser;</span><br><span class="line">        config = <span class="keyword">new</span> SpelParserConfiguration(SpelCompilerMode.IMMEDIATE, RunSpel.class.getClassLoader());</span><br><span class="line">        parser = <span class="keyword">new</span> SpelExpressionParser(config);</span><br><span class="line">        StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">        Integer result = <span class="number">0</span>;</span><br><span class="line">        String expressionStr = <span class="string">"#x + #y*2 - #z"</span>;</span><br><span class="line">        Date start = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">for</span> (Integer xval = <span class="number">0</span>; xval &lt; xmax; xval++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Integer yval = <span class="number">0</span>; yval &lt; ymax; yval++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Integer zval = <span class="number">0</span>; zval &lt;= zmax; zval++) &#123;</span><br><span class="line">                    context.setVariable(<span class="string">"x"</span>, xval);</span><br><span class="line">                    context.setVariable(<span class="string">"y"</span>, yval);</span><br><span class="line">                    context.setVariable(<span class="string">"z"</span>, zval);</span><br><span class="line">                    Expression expression = parser.parseExpression(expressionStr);</span><br><span class="line">                    Integer cal = expression.getValue(context, Integer.class);</span><br><span class="line">                    result += cal;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Date end = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"SpEL:time is : "</span> + (end.getTime() - start.getTime()) + <span class="string">",result is "</span> + result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runGroovyClass</span><span class="params">(<span class="keyword">int</span> xmax, <span class="keyword">int</span> ymax, <span class="keyword">int</span> zmax)</span> </span>&#123;</span><br><span class="line">        GroovyClassLoader loader = <span class="keyword">new</span> GroovyClassLoader();</span><br><span class="line">        Class groovyClass = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            groovyClass = loader.parseClass(<span class="keyword">new</span> File(</span><br><span class="line">                    <span class="string">"GroovyCal.groovy"</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        GroovyObject groovyObject = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            groovyObject = (GroovyObject) groovyClass.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Integer result = <span class="number">0</span>;</span><br><span class="line">        Date start = <span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> xval = <span class="number">0</span>; xval &lt; xmax; xval++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> yval = <span class="number">0</span>; yval &lt; ymax; yval++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> zval = <span class="number">0</span>; zval &lt;= zmax; zval++) &#123;</span><br><span class="line">                    Object[] args = &#123;xval,yval,zval&#125;;</span><br><span class="line">                    Integer cal = (Integer) groovyObject.invokeMethod(<span class="string">"cal"</span>, args);</span><br><span class="line">                    result += cal;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Date end = <span class="keyword">new</span> Date();</span><br><span class="line">        System.out.println(<span class="string">"Groovy Class:time is : "</span> + (end.getTime() - start.getTime()) + <span class="string">",result is "</span> + result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本文的代码可以参见<a href="https://github.com/brucefengnju/eldemo" target="_blank" rel="external">eldemo github</a> 。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><blockquote>
<p><a href="https://news.ycombinator.com/item?id=4558272" target="_blank" rel="external">Groovy vs Java Performance</a> </p>
<p><a href="https://yq.aliyun.com/articles/2357" target="_blank" rel="external">Groovy与Java集成常见的坑</a> </p>
<p><a href="https://commons.apache.org/proper/commons-ognl/language-guide.html" target="_blank" rel="external">OGNL language guide</a> </p>
<p><a href="http://xiongzheng.me/question/2015/01/02/groovy-permgen-out/?spm=5176.100239.blogcont.8.sMPc7M" target="_blank" rel="external">Groovy引发的PermGen区爆满问题定位与解决</a></p>
<p><a href="http://www.bubuko.com/infodetail-670047.html?spm=5176.100239.blogcont.9.sMPc7M" target="_blank" rel="external">groovy脚本导致的FullGC问题</a></p>
<p><a href="http://ju.outofmemory.cn/entry/129930?spm=5176.100239.blogcont.10.sMPc7M" target="_blank" rel="external">Groovy性能问题</a></p>
<p><a href="http://www.zgxue.com/120/1204001.html?spm=5176.100239.blogcont.11.sMPc7M" target="_blank" rel="external">Groovy的classloader加载机制唤起的频繁GC</a></p>
<p><a href="http://johnnyjian.iteye.com/blog/1847151?spm=5176.100239.blogcont.12.sMPc7M" target="_blank" rel="external">Groovy深入探索——Groovy的ClassLoader体系</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/dynamic-code-in-java/" data-id="cipak1vpk0009y95nz0vwl0rh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/动态代码-Groovy-OGNL-SpEL-MVEL/">动态代码 Groovy OGNL SpEL MVEL</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-业务系统重构总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/system-reconstruct-summary/" class="article-date">
  <time datetime="2016-04-23T13:18:00.000Z" itemprop="datePublished">2016-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/system-reconstruct-summary/">业务系统重构总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前在<a href="http://blog.brucefeng.info/post/service-design-patterns-practices" target="_blank" rel="external">服务化设计模式实践</a> 里面介绍了交易侧系统服务变迁的模式，服务的变迁更好的支持了业务的发展，伴随着业务的发展，对业务系统内部的要求也更好，需要具有更好的扩展性。随着业务的不断发展，每个服务内部的逻辑也变得越来越多，需要有更好的抽象来支持以后更多的业务类型。</p>
<h3 id="1-项目业务背景"><a href="#1-项目业务背景" class="headerlink" title="1. 项目业务背景"></a>1. 项目业务背景</h3><p>重构的项目有订单服务，预订系统，退款系统；这三个系统都是与用户交易行为息息相关。</p>
<p>其中订单系统参与重构的模块为订单创建，订单状态流转，订单支付；</p>
<p>预订系统的重构主要为了支撑更多的预订方式，如之前已经支持的库存模式、商家接单模式和售中客服模式，伴随着重构还需要支持商家系统直连模式，而且需要能够支持以后业务发展更多的预订模式。</p>
<p>退款服务的复杂度主要来源于多种退款类型，如用户退款，系统退款，商家退款和客服退款等多种类型，而每种类型又有各种不同的退款规则；退款服务需要支持多种业务，如已有的KTV预订和将要扩展出的酒水点单。</p>
<p>在这里我们主要来讲讲预订系统重构，因为这个系统的重构几乎涵盖了订单服务和退款服务重构所使用到的技术</p>
<h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><ul>
<li>抽象预订流程，并模板化</li>
<li>对可变化的部分支持配置化　</li>
<li>在上线过程中支持新老流程切换　</li>
</ul>
<h3 id="2-业务抽象"><a href="#2-业务抽象" class="headerlink" title="2. 业务抽象"></a>2. 业务抽象</h3><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%A2%84%E8%AE%A2%E6%9C%8D%E5%8A%A1%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>由图中可以看出，业务流程非常复杂，一个订单的预订过程会根据不同的情况走不同的预订渠道，如果一个预订渠道因为某种原因预订失败了，可能会继续使用另外一个预订渠道继续进行预订，也就是会发生流转。</p>
<p>另外，在预订成功和预订失败时，会需要做一些其他操作，例如发送短信告知用户结果等；<br>图中还有一点没有体现的是，在开始发起预订时，需要校验数据的正确性，校验是否复核预订规则等等校验。</p>
<p>根据这些条件我们做了以下抽象：</p>
<ul>
<li>首先订单从预订开始、预订中到预订成功/失败定义为预订的主流程，其中每个接单都是一个重要的业务节点，这种主流程定义为一级业务。</li>
<li>对于不同的预订模式（如库存模式、商家接单模式、客服售中介入模式和商家系统直连等），抽象为预订渠道。预订渠道之前的转化定义为渠道流转。<img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%A2%84%E8%AE%A2%E6%B8%A0%E9%81%93.png" alt=""></li>
<li>预订渠道会直接影响预订结果</li>
<li>预订中、预订成功/失败 时渠道需要个性化的操作，如商家接单渠道开始时需要通知商家等，这种流程会影响一级业务，但其业务具有个性化特征，因此定义为二级业务。</li>
<li>同时预订中、预订成功/失败后 需要进行不影响业务流程的操作，如发送短信告知用户预订结果，记录一些属性等等。这部分业务定义为三级业务。</li>
</ul>
<p>一级业务是系统最重要的业务，业务流程标准化且会直接影响业务结果；二级业务是一级业务一个步骤，但因为预订渠道的不同而有个性化操作；三级业务是根据业务结果来执行的操作，不会再影响系统的主流程。</p>
<h3 id="3-重构"><a href="#3-重构" class="headerlink" title="3. 重构"></a>3. 重构</h3><h4 id="3-1-核心业务流程"><a href="#3-1-核心业务流程" class="headerlink" title="3.1 核心业务流程"></a>3.1 核心业务流程</h4><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%A2%84%E8%AE%A2%E9%87%8D%E6%9E%84%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B.png" alt=""><br>预订中核心业务流程是最重要的部分，也就是图中所标注的一级业务，每一个步骤都是一个重要的业务节点，且每一个节点都会有一些复杂的逻辑。<br>因此在重构时，将核心业务流程的实现定义为一个模板引擎，在这个模板引擎中的每一个节点都可以是一个接口，可以任意的配置。在代码上的表现就会是这样的。</p>
<p>开始预订：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KtvReserveService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> KtvReserveResultDTO <span class="title">reserve</span><span class="params">(KtvReserveContext reserveContext)</span> <span class="keyword">throws</span> ReserveException </span>&#123;</span><br><span class="line">	  <span class="comment">// 校验</span></span><br><span class="line">	    KtvValidateResult validateResult = <span class="keyword">this</span>.ktvReserveValidateStack.validate(reserveContext);</span><br><span class="line">	    <span class="keyword">if</span> (validateResult == <span class="keyword">null</span> || !validateResult.isValid()) &#123;</span><br><span class="line">	        <span class="keyword">return</span> KtvReserveResultDTO.createFailedResult(<span class="string">"validate invalid"</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="comment">//判定预订渠道</span></span><br><span class="line">	    KtvReserveChannel reserveChannel = reserveChannelJudgeService.judgeChannelType(reserveContext);</span><br><span class="line">	    reserveDataService.store()</span><br><span class="line">	   reserveDataService.transferReserveChannelStatus();</span><br><span class="line">	<span class="comment">//开始渠道预订</span></span><br><span class="line">	    ChannelResult channelResult = <span class="keyword">this</span>.reserveChannelService.reserve(reserveContext);</span><br><span class="line">	    <span class="keyword">return</span> KtvReserveResultDTO</span><br><span class="line">	            .genResult(channelResult.isSuccess(), channelResult.getDesc(), reserveFlow.getReserveId());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>渠道反馈预订结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KtvReplyReserveService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ReplyReserveResult <span class="title">reply</span><span class="params">(KtvReplyReserveInfo replyReserveInfo)</span> <span class="keyword">throws</span> ReplyReserveException </span>&#123;</span><br><span class="line">	  <span class="comment">//校验</span></span><br><span class="line">	    KtvValidateResult validateResult = replyReserveValidateStack.validate(replyReserveInfo);</span><br><span class="line">	    <span class="keyword">if</span> (validateResult == <span class="keyword">null</span> || !validateResult.isValid()) &#123;</span><br><span class="line">	        logger.warn(String.format(<span class="string">" %s validate failed"</span>, param));</span><br><span class="line">	        <span class="keyword">return</span> ReplyReserveResult.createFailedResult(<span class="string">"validate failed"</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="comment">//更新预订状态</span></span><br><span class="line">	    reserveDataService.transferReserveChannelStatus();</span><br><span class="line">	</span><br><span class="line">	    ReplyReserveResult result;</span><br><span class="line">	    <span class="comment">//判定预订结果</span></span><br><span class="line">	    KtvReserveStatus toReserveStatus = <span class="keyword">this</span>.reserveChannelJudgeService.judgeReserveResult(replyReserveInfo);</span><br><span class="line">	    <span class="keyword">boolean</span> reserveFailed =</span><br><span class="line">	            toReserveStatus == <span class="keyword">null</span> || toReserveStatus == KtvReserveStatus.ReserveFailed || toReserveStatus == KtvReserveStatus.Init;</span><br><span class="line">	    <span class="keyword">if</span> (reserveFailed) &#123;</span><br><span class="line">	      <span class="comment">//预订失败处理</span></span><br><span class="line">	        result = <span class="keyword">this</span>.reserveFailed(replyReserveInfo);</span><br><span class="line">	    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toReserveStatus == KtvReserveStatus.ReserveSuccess) &#123;</span><br><span class="line">	      <span class="comment">//预订成功处理</span></span><br><span class="line">	        result = <span class="keyword">this</span>.reserveSuccess(replyReserveInfo);</span><br><span class="line">	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	      <span class="comment">// 需要转移其他渠道预订</span></span><br><span class="line">	        result = ktvReserveTransferService.transferChannel(ktvReserveContext);</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="comment">// 渠道处理内部事务</span></span><br><span class="line">	    <span class="keyword">this</span>.replyReserveChannelService.reply(replyReserveInfo);</span><br><span class="line">	    <span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-2-校验栈"><a href="#3-2-校验栈" class="headerlink" title="3.2 校验栈"></a>3.2 校验栈</h4><p>在业务性很强的服务来说，在业务开始之前需要有复杂的校验，如果在这个服务中支持多种业务类型，还需要根据不同的业务类型来选择不同的校验逻辑，因此在服务中将校验栈独立出来。</p>
<p>校验栈的组装采用<a href="https://zh.wikipedia.org/wiki/%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F" target="_blank" rel="external">责任链模式</a>，这样每个校验service通过组装的方式即可以灵活支持多种校验。但是对于业务主流程来说，把校验service的组装服务并不适合放在主业务流程里，因此在重构的时候将校验栈的组装逻辑放在一个单独的service中采用<a href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F" target="_blank" rel="external">代理模式</a>进行组装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KtvReserveValidateService</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span><br><span class="line">   *  校验预订信息</span><br><span class="line">   * <span class="doctag">@param</span> reserveContext</span><br><span class="line">   * <span class="doctag">@return</span></span><br><span class="line">   */</span></span><br><span class="line">  <span class="function">KtvValidateResult <span class="title">validate</span><span class="params">(KtvReserveContext reserveContext)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KtvReserveValidateStack</span> <span class="keyword">implements</span> <span class="title">KtvReserveValidateService</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> List&lt;KtvReserveValidateService&gt; validateServices;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValidateServices</span><span class="params">(</span><br><span class="line">	        List&lt;KtvReserveValidateService&gt; validateServices)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">this</span>.validateServices = validateServices;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> KtvValidateResult <span class="title">validate</span><span class="params">(KtvReserveContext reserveContext)</span> </span>&#123;</span><br><span class="line">	    <span class="keyword">if</span> (CollectionUtils.isEmpty(validateServices)) <span class="keyword">return</span> KtvValidateResult.validResut();</span><br><span class="line">	    <span class="keyword">for</span> (KtvReserveValidateService service : validateServices) &#123;</span><br><span class="line">	        KtvValidateResult result = service.validate(reserveContext);</span><br><span class="line">	        <span class="keyword">if</span> (result == <span class="keyword">null</span> || !result.isValid()) <span class="keyword">return</span> result;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">return</span> KtvValidateResult.validResut();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-3-业务分级"><a href="#3-3-业务分级" class="headerlink" title="3.3 业务分级"></a>3.3 业务分级</h4><p>在前面讲到，在重构中将代码功能分成了一级功能，二级功能和三级功能。</p>
<ul>
<li>其中一级功能的每个步骤都需要严格保证，如果发生问题就需要直接影响业务流程，例如在预订业务中，预订数据状态的更新就是一级业务，如果更新失败就需要终结业务；</li>
<li>二级业务也是重要的业务，但是不需要二级业务不能影响最终的业务结果，但是当二级业务出错时也需要及时处理，如在更新订单状态为购买成功时发生错误，需要及时告警，或者异步化保证数据一致性；</li>
<li>三级业务完全不影响业务流程，很多都是异步化调用外部服务，如短信通知用户、双写订单上的预订状态（老业务）等。预订服务中的三级业务都是根据预订结果而触发，因此在这里使用<a href="https://zh.wikipedia.org/wiki/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F" target="_blank" rel="external">观察者模式</a>实现即可。</li>
</ul>
<p>业务服务对业务流程相对较多，而且每一步出现问题都有可能直接影响购买结果，这种与钱息息相关的业务，一单出错就会有各方来追杀，而且也极大影响用户和商家的体验。对业务分级是将不用影响最终结果的业务剥离出去，将最核心的业务重点对待，不同级别用不同的处理方式。</p>
<h4 id="3-4-数据模型统一"><a href="#3-4-数据模型统一" class="headerlink" title="3.4 数据模型统一"></a>3.4 数据模型统一</h4><p>这里的业务模型是业务流程的数据统一。例如在开始预订的业务中使用ReserveContext作为整个业务流程的数据协议，在分业务时也能采用相同的数据，即避免相同数据的重复读取也便于立减和时间。</p>
<p>一个业务流程的处理，其实也是一种服务的处理过程，而数据模型就是其业务的协议，好协议才能产生好实践。</p>
<h4 id="3-4-机制同策略分离"><a href="#3-4-机制同策略分离" class="headerlink" title="3.4 机制同策略分离"></a>3.4 机制同策略分离</h4><p>机制同策略分离是Unix设计中的基本原则之一，是将将程序的引擎（程序核心域的核心算法和逻辑规格）从接口部分（接受用户命令，展示结果等）分离；因为在一个系统中策略变化相对较多，例如预订服务的三级业务中以后并不需要再同步订单上的预订状态，如果策略的变化影响到机制会使得系统很不稳定，有需求修改时会导致系统大的修改，在功能上线需要QA验证的范围也会很大；导致策略变得死板，难以适应用户需求的改变，任何策略的改变都极有可能动摇机制。<br>机制同策略分离的机制引用最广泛的是MVC模式。<br>在这里预订流程的基本模型就是我们的引擎，在引擎中规定了几个基本的业务节点，而每个业务点的实现都有各自的接口规定，如果有需求的变更只需要更改各个业务节点自身的接口实现即可。至于如何接收支付结果发起预订，以及何种情况下反馈预订接口都是与核心流程分离的。</p>
<h3 id="4-如何上线"><a href="#4-如何上线" class="headerlink" title="4. 如何上线"></a>4. 如何上线</h3><p>重构最痛苦的部分是怎么把项目上线。</p>
<p>在这几次的重构中，主要实行了两种重构：</p>
<ul>
<li>项目内部逻辑重构，但没有新建数据表，对外的接口没有修改；</li>
<li>修改了对外的接口，新增了数据表。</li>
</ul>
<p>第一种模式重构，在上线时比较容易，因为基本不用考虑到新老逻辑兼容的问题，第二种模式的重构在上线时需要考虑新老接口的兼容。在这次预订服务重构过程中，修改了对外接口新增了数据记录，而且重构后的系统逻辑也与新的数据表耦合，因此在新老接口上需要做特别的兼容。这次预订服务改造主要涉及到发起预订和预订反馈，因此在兼容上需要在新老逻辑的入口上都需要做数据转换。另外在测试阶段需要模拟上线的步骤，校验上线每个阶段的新老接口兼容如何，功能是否正常。</p>
<p><strong>分拆上线</strong></p>
<p>一般重构的部分不宜过大，过大时需要考虑的兼容就更多，影响到的外界系统也会更多；一般重构最好的方法是分步重构，重构一部分之后验证上线，小步快跑的方式上线。</p>
<h3 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h3><p>在这个重构的过程中我们主要有一下基本的原则：</p>
<ul>
<li>机制同策略分离</li>
<li>协议统一化和简单化</li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%BC%80%E9%97%AD%E5%8E%9F%E5%88%99" target="_blank" rel="external">开闭原则</a></li>
</ul>
<p>主要使用到一下设计模式：</p>
<ul>
<li>代理模式</li>
<li>监听者模式</li>
<li>责任链模式</li>
<li>装饰者模式</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><blockquote>
<p><a href="https://book.douban.com/subject/1467587/" target="_blank" rel="external">UNIX编程艺术</a></p>
<p><a href="https://book.douban.com/subject/1052241/" target="_blank" rel="external">设计模式-可复用面向对象软件的基础</a></p>
<p><a href="https://zh.wikipedia.org/wiki/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F_(%E8%AE%A1%E7%AE%97%E6%9C%BA)" target="_blank" rel="external">设计模式wiki</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/system-reconstruct-summary/" data-id="cipak1vr40010y95nmc6jqe8s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/系统重构-设计模式/">系统重构 设计模式</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-服务化设计模式实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/service-design-patterns-practices/" class="article-date">
  <time datetime="2016-03-19T09:00:00.000Z" itemprop="datePublished">2016-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/service-design-patterns-practices/">服务化设计模式实践</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这篇文章主要是想介绍我们团队在业务发展中业务服务的架构模式变迁，以及服务之前通信的方式变化。</p>
<h3 id="服务化实现"><a href="#服务化实现" class="headerlink" title="服务化实现"></a>服务化实现</h3><p>点评在2012年左右就推荐一些共用系统服务化，到2015年公司全面推进服务化建设，业务逻辑几乎全部沉淀到后台服务，前台的web只提供简单的http 接口，而APP则只负责展示功能。</p>
<p>因此，在我们开始开发时就采用全部服务化的方法。点评自己开发了一套RPC框架——<a href="https://github.com/wu-xiang/pigeon" target="_blank" rel="external">pigeon</a>，这个在之前的博客<a href="/post/what-is-rpc">RPC是什么</a> 有过详细的介绍。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F.png" alt=""></p>
<p>在这里主要介绍后台服务化的变迁模式。</p>
<h3 id="业务背景"><a href="#业务背景" class="headerlink" title="业务背景"></a>业务背景</h3><p>点评的KTV在线预订启动一年多了，一年的过程业务从小到大，再到双平台融合，业务稳定发展；这一年经历是一个大公司内部的创业构成，业务类型不断扩展，要求业务系统能够快速支持业务。</p>
<p>KTV在线预订是一个O2O中到店消费类，业务系统需要提供到店前决策，购买和到店消费及后期的商家结算。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/ktv%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%AE%A2%E7%BA%BF%E4%B8%8A%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<h4 id="业务初期（MVP阶段）"><a href="#业务初期（MVP阶段）" class="headerlink" title="业务初期（MVP阶段）"></a>业务初期（MVP阶段）</h4><p>在业务初期，业务模型基本都是不清晰的，在产品提出基本的产品模型之后，需要在线上快速验证产品。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/MVP%E9%98%B6%E6%AE%B5%E6%9C%8D%E5%8A%A1.png" alt=""></p>
<p>这个阶段因为要快速上线，因此我们只开发一个订单服务，这个订单服务集合了订单功能和预订功能，以及退款等功能，几乎集成了MVP阶段流程的功能。这时候各个阶段功能的数据也都是绑定在订单上的。如预订阶段的数据，退款阶段的数据等。</p>
<h4 id="扩展业务"><a href="#扩展业务" class="headerlink" title="扩展业务"></a>扩展业务</h4><p>这个阶段的业务快速扩张，需要支持多种扩展的业务类型，比如预订的模式就会划分出库存模式和商家接单的模式。</p>
<blockquote>
<ul>
<li>库存模式：是商家预先设定好当日的库存量，只要用户购买是有库存就会立即购买成功。</li>
<li>商家接单模式：商家并没有给出确定，需要用户确定预订之后，商家才会接到通知，然后由商家决定是否接受预订，如果不接受则预订失败。</li>
</ul>
</blockquote>
<p>这个阶段业务开始处于快速发展中了，有了前期一定的用户和订单积累，因此这个阶段需要快速开发同时也要支持更多的业务类型。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E5%BF%AB%E9%80%9F%E5%8F%91%E5%B1%95%E6%9C%9F%E6%9C%8D%E5%8A%A1.png" alt=""></p>
<p>这个阶段因为有着业务快速发展的要求，难以做到数据的独立，因此只能在服务层面做出隔离，但是因为服务都共用了一套订单数据模型，因此其他服务对订单的读取和修改也都是通过订单服务来完成的。这种模式下初步解决了业务扩展的问题，如多做预订模式，多种退款场景等；但这种方式的缺点非常明显：</p>
<ul>
<li>数据混合，导致数据模型混乱，且难以在根源上支持业务扩展；</li>
<li>订单服务成为单点服务。</li>
</ul>
<h4 id="稳定发展期"><a href="#稳定发展期" class="headerlink" title="稳定发展期"></a>稳定发展期</h4><p>业务开始进入稳定发展期，对系统的稳定性和可靠性有了更高的要求，而且这个阶段的流量也开始变高；同时也需要有新的业务类型引入。为了解决上面所提到的问题就需要通过分离数据来解决上面数据混合的问题。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E7%A8%B3%E5%AE%9A%E6%9C%9F%E6%9C%8D%E5%8A%A1-%E6%95%B0%E6%8D%AE%E7%8B%AC%E7%AB%8B.png" alt=""></p>
<p>这种模式情况下，相互之前的业务数据独立了，单点的服务也基本处理了，这种架构以及可以基本支持目前的业务。</p>
<p>但是很多服务对订单的访问基本都是查询订单数据，而这部分请求也最高的，但却并不是最重要的；对于订单业务而言，最重要的核心节点是下单和订单状态流转。因此我们在使用了上面的模式之后，渐渐将订单服务裂变出创建订单服务和订单查询服务。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E7%A8%B3%E5%AE%9A%E6%9C%9F%E5%8F%91%E5%B1%95-%E8%A3%82%E5%8F%98.png" alt=""></p>
<h4 id="未来服务的规划"><a href="#未来服务的规划" class="headerlink" title="未来服务的规划"></a>未来服务的规划</h4><p>目前这个阶段，有很多的逻辑需要查询订单的信息，而订单信息针对调用方来说需要订单角度的很多信息，如订单退款信息（退款时间，是否退款成功），消费状态等等；这些信息需要调用多个服务（如订单查询服务，消费服务和退款服务），而这种信息的查询需要有多个业务方来调用，如果这个功能都需要业务方查询组装的话，反而使得业务过于零散。因此在未来将会新增一些聚合服务，而原有的服务将成为基础服务；聚合服务主要是调用基础服务，并将基础服务的数据进行组装和流程处理；基础服务则定义更为基础，只处理本领域内的业务。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2.png" alt=""></p>
<h3 id="服务的设计模式"><a href="#服务的设计模式" class="headerlink" title="服务的设计模式"></a>服务的设计模式</h3><p>通过上面的模式变迁，在这个过程中，主要使用到了一下的集中服务设计模式：</p>
<ul>
<li>共享数据模式</li>
<li>异步消息传递模式</li>
<li>聚合期的服务模式</li>
</ul>
<p>这些概念在之前的一篇博客<a href="/post/which-kind-microservice-weneed">我们需要什么样的微服务</a> 中有更为详细的介绍。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><blockquote>
<p><a href="/post/what-is-rpc">RPC是什么</a></p>
<p><a href="/post/which-kind-microservice-weneed">我们需要什么样的微服务</a> </p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/service-design-patterns-practices/" data-id="cipak1vrv001fy95nbv7hgu20" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/microservice-design-patterns/">microservice design-patterns</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-浏览器与服务器的消息通信" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/brower-server-msg/" class="article-date">
  <time datetime="2016-02-22T02:55:00.000Z" itemprop="datePublished">2016-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/brower-server-msg/">浏览器与服务器的消息通信</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近工作中遇到一个场景，商家在商家后台需要实时的获取到有没有新订单，有的话是几个；这个需求类似与日常中使用QQ或者微信时的新信息提醒一样，只要有新信息就需要提醒；商家基本在PC上使用，各式浏览器都有:如 IE系列（7.0，8.0，9.0及以上），chrome内核，firefox等；功能所属的部署在Tomcat 6.0上，如果技术需要可以部署到 Tomcat 7.0上;<br>我们先做做技术调研，这种浏览器与服务器实时通信的方式有哪些方式。</p>
<h3 id="AJAX轮询"><a href="#AJAX轮询" class="headerlink" title="AJAX轮询"></a>AJAX轮询</h3><p>这是我们最自然想到的。 采用常规AJAX轮询的方式，每10s或者30s轮询一次，既可以判断出有有多少个新订单进入，且这种时间间隔对于消息提醒也是可以接受的。这种技术方式实现起来非常简单，目前的机器都是可以机器的，前端浏览器也都支持。<br>但是这种方式会有非常严重的问题，就是需要不断的向服务器发送消息询问，如果有1w个商家打开了浏览器，采用10s轮询的方式，则服务器则会承担1000 的QPS，这1w个商家可能只有10个有订单通知；这种方式会对服务器造成极大的性能浪费。<br>还有一个类似的轮询是使用<a href="/post/web-crossdomain-2016">JSONP跨域请求</a>的方式轮询，在实现起来有差别，但基本原理都是相同的，都是客户端不断的向服务器发起请求。</p>
<p><strong>优点</strong><br>实现简单。<br><strong>缺点</strong><br> 这是通过模拟服务器发起的通信，不是实时通信，不顾及应用的状态改变而盲目检查更新，导致服务器资源的浪费，且会加重网络负载，拖累服务器。</p>
<h3 id="Comet"><a href="#Comet" class="headerlink" title="Comet"></a>Comet</h3><p>Comet是一种用于Web的推送技术，能使服务器实时地将更新的信息传送到客户端，而无须客户端发出请求，目前有两种实现方式：</p>
<h4 id="长轮询（long-polling"><a href="#长轮询（long-polling" class="headerlink" title="长轮询（long polling)"></a>长轮询（long polling)</h4><p>长轮询 (long polling) 是在打开一条连接以后保持，等待服务器推送来数据再关闭，可以采用HTTP长轮询和XHR长轮询两种方式。<br><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%95%BF%E8%BD%AE%E8%AF%A2.png" alt=""></p>
<h5 id="HTTP-和JSONP方式的长轮询"><a href="#HTTP-和JSONP方式的长轮询" class="headerlink" title="HTTP 和JSONP方式的长轮询"></a>HTTP 和JSONP方式的长轮询</h5><p>把 script 标签附加到页面上以让脚本执行。服务器会挂起连接直到有事件发生，接着把脚本内容发送回浏览器，然后重新打开另一个 script 标签来获取下一个事件，从而实现长轮询的模型。</p>
<h5 id="XHR长轮询"><a href="#XHR长轮询" class="headerlink" title="XHR长轮询"></a>XHR长轮询</h5><p>这种方式是使用比较多的长轮询模式。<br>客户端打开一个到服务器端的 AJAX 请求然后等待响应；服务器端需要一些特定的功能来允许请求被挂起，只要一有事件发生，服务器端就会在挂起的请求中送回响应并关闭该请求。客户端 JavaScript 响应处理函数会在处理完服务器返回的信息后，再次发出请求，重新建立连接；如此循环。<br>现在浏览器已经支持<a href="/post/web-crossdomain-2016">CROS的跨域方式</a>请求，因此HTTP和JSONP的长轮询方式是慢慢被淘汰的一种技术，建议采用XHR长轮询。</p>
<h5 id="长轮询优缺点"><a href="#长轮询优缺点" class="headerlink" title="长轮询优缺点"></a>长轮询优缺点</h5><p><strong>优点</strong><br>客户端很容易实现良好的错误处理系统和超时管理，实现成本与Ajax轮询的方式类似。<br><strong>缺点</strong><br>需要服务器端有特殊的功能来临时挂起连接。<br>当客户端发起的连接较多时，服务器端会长期保持多个连接，具有一定的风险。</p>
<h4 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h4><p>iframe 是很早就存在的一种 HTML 标记， 通过在 HTML 页面里嵌入一个隐蔵帧，然后将这个隐蔵帧的 SRC 属性设为对一个长连接的请求，服务器端就能源源不断地往客户端输入数据。<br><img src="http://7xkbey.com1.z0.glb.clouddn.com/iframe.png" alt=""></p>
<p><strong>优点：</strong><br>这种方式每次数据传送不会关闭连接，连接只会在通信出现错误时，或是连接重建时关闭（一些防火墙常被设置为丢弃过长的连接， 服务器端可以设置一个超时时间， 超时后通知客户端重新建立连接，并关闭原来的连接）。<br><strong>缺点</strong><br>IE、Morzilla Firefox 下端的进度栏都会显示加载没有完成，而且 IE 上方的图标会不停的转动，表示加载正在进行。<br>Google 的天才们使用一个称为“htmlfile”的 ActiveX 解决了在 IE 中的加载显示问题，并将这种方法用到了 gmail+gtalk 产品中。Alex Russell 在 “What else is burried down in the depth’s of Google’s amazing JavaScript?”文章中介绍了这种方法。Zeitoun 网站提供的 comet-iframe.tar.gz，封装了一个基于 iframe 和 htmlfile 的 JavaScript comet 对象，支持 IE、Mozilla Firefox 浏览器，可以作为参考。<br>我们常用的网页版的gtalk就是这种实现方式,Google的开发人员使使用一个称为“htmlfile”的 ActiveX 解决了在 IE 中的加载显示问题。</p>
<h4 id="Comet实现框架"><a href="#Comet实现框架" class="headerlink" title="Comet实现框架"></a>Comet实现框架</h4><h5 id="CometD"><a href="#CometD" class="headerlink" title="CometD"></a>CometD</h5><p><a href="https://cometd.org/" target="_blank" rel="external">CometD</a> 框架是基于 HTTP 的事件驱动通信解决方案，使用了Bayeux通信协议，提供了一个 Java 服务器部件和一个 Java 客户端部件，还有一个基于 jQuery 和 Dojo 的 JavaScript 客户端库。<br>&gt;<br>Bayeux 通信协议主要是基于 HTTP，提供了客户端与服务器之间的响应性双向异步通信。Bayeux 协议基于通道进行通信，通过该通道从客户端到服务器、从服务器到客户端或从客户端到客户端（但是是通过服务器）路由和发送消息。Bayeux 是一种 “发布- 订阅” 协议。</p>
<p>CometD 与三个传输协议绑定在一起：JSON、JSONP 和 WebSocket。他们都依赖于 Jetty Continuations 和 Jetty WebSocket API。在默认情况下，可以在 Jetty 6、Jetty 7、和 Jetty 8 中以及其他所有支持 Servlet 3.0 Specification 的服务中使用 CometD。<br><img src="http://www.ibm.com/developerworks/cn/web/wa-reverseajax4/fig02.gif" alt=""><strong><a href="http://www.ibm.com/developerworks/cn/web/wa-reverseajax4/fig02.gif" target="_blank" rel="external">服务器和内部构件</a></strong></p>
<h4 id="Atmosphere框架"><a href="#Atmosphere框架" class="headerlink" title="Atmosphere框架"></a><a href="https://github.com/Atmosphere/atmosphere" target="_blank" rel="external">Atmosphere框架</a></h4><p>Atmosphere提供了一个通用 API，以便使用许多 Web 服务器（包括 Tomcat、Jetty、GlassFish、Weblogic、Grizzly、JBossWeb、JBoss 和 Resin）的 Comet 和 WebSocket 特性。它支持任何支持 Servlet 3.0 Specification 的 Web 服务器。<br><img src="http://www.ibm.com/developerworks/cn/web/wa-reverseajax4/fig01.gif" alt=""><br>Atmosphere 提供了一个 jQuery 客户端库，该库可以使连接设置变得更容易，它能够自动检测可以使用的最佳传输协议（WebSockets 或 CometD）。Atmosphere 的 jQuery 插件的用法与 HTML5 WebSockets API 相似。</p>
<h4 id="Pushlet"><a href="#Pushlet" class="headerlink" title="Pushlet"></a><a href="http://www.pushlets.com/" target="_blank" rel="external">Pushlet</a></h4><p>Pushlet 使用了观察者模型：客户端发送请求，订阅感兴趣的事件；服务器端为每个客户端分配一个会话 ID 作为标记，事件源会把新产生的事件以多播的方式发送到订阅者的事件队列里。<br>Pushlet 最后更新于2010年2月5号，之后至今没有再更新。</p>
<p>Cometd 和Atmosphere框架参见示例代码 (<a href="https://github.com/brucefengnju/cometdatoms)。" target="_blank" rel="external">https://github.com/brucefengnju/cometdatoms)。</a></p>
<h3 id="Comet实现要点"><a href="#Comet实现要点" class="headerlink" title="Comet实现要点"></a>Comet实现要点</h3><p><strong>不要在同一客户端同时使用超过两个的 HTTP 长连接</strong><br>HTTP 1.1 规范中规定，客户端不应该与服务器端建立超过两个的 HTTP 连接， 新的连接会被阻塞，在IE浏览器中严格遵守了这种规定。</p>
<p><strong>服务器端的性能和可扩展性</strong><br>一般 Web 服务器会为每个连接创建一个线程，如果在大型的商业应用中使用 Comet，服务器端需要维护大量并发的长连接。在这种应用背景下，服务器端需要考虑负载均衡和集群技术；或是在服务器端为长连接作一些改进。</p>
<p><strong>在客户和服务器之间保持“心跳”信息</strong><br>在浏览器与服务器之间维持一个长连接会为通信带来一些不确定性：因为数据传输是随机的，客户端不知道何时服务器才有数据传送。服务器端需要确保当客户端不再工作时，释放为这个客户端分配的资源，防止内存泄漏。因此需要一种机制使双方知道双方都在正常运行。<br>服务器端在阻塞读时会设置一个时限，超时后阻塞读调用会返回，同时发给客户端没有新数据到达的心跳信息。此时如果客户端已经关闭，服务器往通道写数据会出现异常，服务器端就会及时释放为这个客户端分配的资源。<br>如果客户端使用的是基于 AJAX 的长轮询方式；服务器端返回数据、关闭连接后，经过某个时限没有收到客户端的再次请求，会认为客户端不能正常工作，会释放为这个客户端分配、维护的资源。<br>当服务器处理信息出现异常情况，需要发送错误信息通知客户端，同时释放资源、关闭连接。</p>
<h3 id="websocket-https-zh-wikipedia-org-wiki-WebSocket"><a href="#websocket-https-zh-wikipedia-org-wiki-WebSocket" class="headerlink" title="[websocket] (https://zh.wikipedia.org/wiki/WebSocket)"></a>[websocket] (<a href="https://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="external">https://zh.wikipedia.org/wiki/WebSocket</a>)</h3><p>WebSocket是HTML5开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。WebSocket通讯协议于2011年被IETF定为标准RFC 6455，WebSocketAPI被W3C定为标准。在WebSocket API中，浏览器和服务器只需要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。两者之间就直接可以数据互相传送。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/websocket.png" alt=""></p>
<h4 id="浏览器支持"><a href="#浏览器支持" class="headerlink" title="浏览器支持"></a>浏览器支持</h4><table>
<thead>
<tr>
<th>浏览器</th>
<th>版本支持</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chrome</td>
<td>4+</td>
</tr>
<tr>
<td>Firefox</td>
<td>4+</td>
</tr>
<tr>
<td>IE</td>
<td>10+</td>
</tr>
<tr>
<td>Opera</td>
<td>10+</td>
</tr>
<tr>
<td>Safari</td>
<td>5+</td>
</tr>
</tbody>
</table>
<p>详情查看 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API" target="_blank" rel="external">Browser compatibility</a></p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>WebSocket的实现已经有很多种版本，详细可以查看<a href="http://www.websocket.org/demos.html" target="_blank" rel="external">DEMO</a>。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总结下来长轮询不是一个很好的方案，而且对于服务器而言是有风险的；另外支持WebSocket协议的浏览器都比较新，特比是IE需要10以上的版本；而我们的业务是面向于商家端，商家的浏览器版本相对较低，很多对WebSocket都不支持；相对而言Comet的方式比较适合，也有相应的实现框架，实现成本最低；因此最后我们还是决定使用Comet的方式来实现，后面上线运行一段时间之后再来给大家介绍。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><blockquote>
<p><a href="https://en.wikipedia.org/wiki/Comet_(programming" target="_blank" rel="external">comet wiki</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/wa-lo-comet/" target="_blank" rel="external">Comet：基于 HTTP 长连接的“服务器推”技术</a></p>
<p><a href="http://www.ibm.com/developerworks/cn/web/wa-reverseajax1/" target="_blank" rel="external">反向 Ajax，第 1 部分: Comet 简介</a><br><a href="https://infrequently.org/2006/02/what-else-is-burried-down-in-the-depths-of-googles-amazing-javascript/" target="_blank" rel="external">What else is burried down in the depth’s of Google’s amazing JavaScript?</a><br><a href="https://www.zhihu.com/question/20215561" target="_blank" rel="external">WebSocket 是什么原理？为什么可以实现持久连接</a><br><a href="http://www.infoq.com/cn/news/2008/12/websockets-vs-comet-ajax" target="_blank" rel="external">Ajax、Comet、HTML 5 Web Sockets技术比较分析</a><br><a href="https://zh.wikipedia.org/wiki/WebSocket" target="_blank" rel="external">WebSocket wiki</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/web/1112_huangxa_websocket/" target="_blank" rel="external">使用 HTML5 WebSocket 构建实时 Web 应用</a></p>
<p><a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="external">The WebSocket Protocol</a><br><a href="https://http2.github.io/faq/#how-can-i-use-http2-server-push" target="_blank" rel="external">How can I use HTTP/2 server push?</a><br><a href="https://webtide.com/http2-push-with-experimental-servlet-api/" target="_blank" rel="external">HTTP/2 Push with experimental Servlet API</a><br><a href="https://webtide.com/http2-interoperability-http2-push/" target="_blank" rel="external">HTTP/2 Interoperability and HTTP/2 Push</a><br><a href="http://ajaxian.com/archives/google-talk-client-in-javascript" target="_blank" rel="external">/google-talk-client-in-javascript</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/brower-server-msg/" data-id="cipak1vru001dy95njtrv1yis" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/实时通信-comet-websocket/">实时通信 comet websocket</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016新年计划.comments" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/undefined/" class="article-date">
  <time datetime="2016-02-18T06:26:25.000Z" itemprop="datePublished">2016-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>date: 2016-02-16 09:54:53<br>author: sinopex<br>email: wsj6563@gmail.com<br>site:<br>ip: 116.231.180.8</p>
<p>楼主好励志！！！</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/undefined/" data-id="cipak1voj0000y95nfvsuuaw3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-前端跨域访问" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/web-crossdomain-2016/" class="article-date">
  <time datetime="2016-02-07T02:39:00.000Z" itemprop="datePublished">2016-02-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/web-crossdomain-2016/">前端跨域访问</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在互联网应用中：</p>
<ul>
<li>一个页面需要请求多个域名下的web服务端接口</li>
<li>同时一个web服务接口可能会被很多不同域名下的页面请求。</li>
</ul>
<p>一个web应用如果支持为了支持以上模式而申请多个域名是不合算的，因为域名申请和管理所占用的资源比较大，因此服务端支持跨域就成了一个更合理的解决方案。<br>解决跨域的方式主要有两种：</p>
<h3 id="1-JSONP"><a href="#1-JSONP" class="headerlink" title="1. JSONP"></a>1. JSONP</h3><p>关于<a href="https://zh.wikipedia.org/wiki/JSONP" target="_blank" rel="external">JSONP的基本概念</a>就不多介绍了，现在在<a href="https://www.google.com.hk/search?q=jsonp&amp;ei=6GS5VraXHsO60ATcp7vAAQ&amp;start=10&amp;sa=N&amp;biw=1280&amp;bih=678&amp;dpr=2" target="_blank" rel="external">网上已经有很多解释</a>。JSONP模式下前端Client可以跨域请求JSON文件，进而实现前端跨域请求其他服务器资源的目的。<br>目前在一些流行的JavaScript库中对JSONP和Ajax的支持方式在表现形式上非常相近，在代码中写法几乎都是相同的，但是JSONP与Ajax是完全不同的原理。JSONP是以请求文件数据的方式向服务器发出请求，而Ajax是使用XMLHttpRequest向服务器异步发出请求。</p>
<ul>
<li><p>优点<br>JSONP并不需要浏览器特殊支持，可以说所有的浏览器都是支持JSONP请求的。而且目前各流行JavaScript类库对JSONP的支持已经很全面，开发中也比较方便。</p>
</li>
<li><p>缺点<br>但JSONP的请求只能是GET请求，因为在请求URL有长度限制，一般情况下只要不超过2000字符都是可以的(<a href="http://www.boutell.com/newfaq/misc/urllength.html" target="_blank" rel="external">What is the maximum length of a URL?</a>)，主流浏览器所支持的长度也越来越放宽，基本是可以满足条件的。<br>JSONP的web服务端接口因为无法限制接收指定域名的请求，因此在实际应用中需要在安全性方面进行更多限制，以避免接口数据泄漏。</p>
</li>
</ul>
<h3 id="2-CORS（Cross-origin-resource-sharing）"><a href="#2-CORS（Cross-origin-resource-sharing）" class="headerlink" title="2. CORS（Cross-origin resource sharing）"></a>2. CORS（Cross-origin resource sharing）</h3><p>主要是通过定义浏览器与服务器之间共享内容的方式来实现跨域。<br>CORS通过新增一系列 HTTP 头（Access-Control-Allow-Origin，Access-Control-Expose-Headers，Access-Control-Max-Age，Access-Control-Allow-Credentials，Access-Control-Allow-Methods，Access-Control-Allow-Headers等），让服务器能声明那些来源可以通过浏览器访问该服务器上的资源。另外，对那些会对服务器数据造成破坏性影响的 HTTP 请求方法（特别是 GET 以外的 HTTP 方法，或者搭配某些MIME类型的POST请求），标准强烈要求浏览器必须先以 OPTIONS 请求方式发送一个预请求(preflight request)，从而获知服务器端对跨源请求所支持 HTTP 方法。在确认服务器允许该跨源请求的情况下，以实际的 HTTP 请求方法发送那个真正的请求。服务器端也可以通知客户端，是不是需要随同请求一起发送信用信息（包括 Cookies 和 HTTP 认证相关数据）。</p>
<h4 id="2-1-运行模式"><a href="#2-1-运行模式" class="headerlink" title="2.1 运行模式"></a>2.1 运行模式</h4><p><img src="http://7xkbey.com1.z0.glb.clouddn.com/Cros%E5%8E%9F%E7%90%86.png" alt=""></p>
<p>如果只使用简单请求向服务器发出请求，则浏览器就不需要向服务器发送预请求，服务器端只需要在response中增加Access-Control-Allow-Origin就可以了，开发非常简单，在代码上和Ajax请求几乎没有区别。</p>
<blockquote>
<p>简单请求：只使用 GET, HEAD 或者 POST 请求方法。如果使用 POST 向服务器端传送数据，则数据类型(Content-Type)只能是 application/x-www-form-urlencoded, multipart/form-data 或 text/plain中的一种。不会使用自定义请求头（类似于 X-Modified 这种）。<br>但请求以如果 GET, HEAD 或者 POST 以外的方法发起请求。或者，使用 POST，但请求数据为 application/x-www-form-urlencoded, multipart/form-data 或者 text/plain 以外的数据类型。比如说，用 POST 发送数据类型为 application/xml 或者 text/xml 的 XML 数据的请求或者使用自定义请求头（比如添加诸如 X-PINGOTHER）时，浏览器就需要向服务器发送预请求，以确定服务器是否支持后续请求，如果支持，浏览器则继续发送后续Ajax请求。</p>
</blockquote>
<h4 id="2-2-JQuery支持CORS"><a href="#2-2-JQuery支持CORS" class="headerlink" title="2.2  JQuery支持CORS"></a>2.2  JQuery支持CORS</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">  <span class="comment">//PUT 和DELETE  需要发送预请求</span></span><br><span class="line">  type: <span class="string">'HTTP METHOD'</span>,<span class="comment">//如GET  ，POST  </span></span><br><span class="line">  url: <span class="string">'cross-domain-url'</span>,</span><br><span class="line">  contentType: ,</span><br><span class="line"></span><br><span class="line">  xhrFields: &#123;</span><br><span class="line">    withCredentials: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  headers: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  success: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  error: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>详细的使用参见<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">HTTP访问控制(CORS)</a>。</p>
<h4 id="2-3-与JSONP相比"><a href="#2-3-与JSONP相比" class="headerlink" title="2.3 与JSONP相比"></a>2.3 与JSONP相比</h4><p>CORS的开发更为简单，对安全性的控制更为灵活，且目前所有的<a href="http://caniuse.com/#feat=cors" target="_blank" rel="external">现代浏览器都已经支持了CORS</a>模式，CORS支持所有的HTTP Method类型，在Restful请求中可以实现跨域。</p>
<h3 id="3-跨域访问在点评的应用"><a href="#3-跨域访问在点评的应用" class="headerlink" title="3. 跨域访问在点评的应用"></a>3. 跨域访问在点评的应用</h3><p>在点评，很多功能采用<a href="/post/static-backend-asolate">动静分离</a>的方式，在项目部署上也采用前端静态文件资源与后端web服务独立域名的方式进行；这种模式下，后端的HTTP 接口对于前端而言是一个服务接口；例如一个查询用户是否登录的接口，可能会被多个项目使用，因此就要求服务端接口支持跨域请求。<br>目前在点评中主要使用JSONP的方式来实现跨域请求；因为CORS算是一个新技术，因此还没有大规模使用，只会在一些不重要的功能中使用过。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><blockquote>
<p><a href="https://zh.wikipedia.org/wiki/JSONP" target="_blank" rel="external">JSONP</a><br><a href="http://www.boutell.com/newfaq/misc/urllength.html" target="_blank" rel="external">What is the maximum length of a URL?</a><br> <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank" rel="external">CORS（Cross-origin resource sharing）</a><br><a href="https://www.w3.org/TR/cors/" target="_blank" rel="external">Cross-Origin Resource Sharing</a><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">HTTP访问控制(CORS)</a><br><a href="https://bugs.jquery.com/query?status=closed&amp;resolution=plugin" target="_blank" rel="external">JQuery CORS  support IE’s XDomainRequest object plugin</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/web-crossdomain-2016/" data-id="cipak1vr80012y95njsyxxaic" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end-cross-domian/">front-end, cross-domian</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-reprinted/转载——高可用性系统在大众点评的实践与经验" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/undefined/" class="article-date">
  <time datetime="2016-01-26T09:26:00.000Z" itemprop="datePublished">2016-01-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/undefined/">转载—高可用性系统在大众点评的实践与经验</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这是一篇完全转载的文章（<a href="http://mp.weixin.qq.com/s?__biz=MzIxMjE3NTg2NA==&amp;mid=404115389&amp;idx=1&amp;sn=dc3d81583c4d2c3c07d6a563880235dd&amp;scene=4#wechat_redirect" target="_blank" rel="external">原文地址</a>)，里面的很多经验都是经历过多血泪史。</p>
<hr>
<blockquote>
<p>高可用性系统在大众点评的实践与经验</p>
<p><em>2016-01-21</em>陈一方 from 井底之蛙</p>
</blockquote>
<p>本文主要以点评的交易系统的演进为主来描述如何做到高可用，并结合自己的经验作些分享。高可用性只是一个结果，要更多的关注迭代过程，关注业务发展。</p>
<p>主要从下面几个方面来分享</p>
<ul>
<li><p>可用性的理解</p>
<ol>
<li>理解目标</li>
<li>目标分解</li>
</ol>
</li>
<li><p>频率要低</p>
<ol>
<li>高可用性的设计</li>
<li>易运营&amp;测试</li>
<li>关注发布</li>
</ol>
</li>
<li><p>时间要快</p>
<p> 1．持续关注运行时</p>
<p> 2．充分利用故障时</p>
</li>
<li><p>几点经验<br> 1．珍惜每次大流量机会</p>
<p> 3．可用性不只是技术问题</p>
<p> 4．可用性最大的敌人</p>
</li>
</ul>
<h3 id="一、可用性的理解"><a href="#一、可用性的理解" class="headerlink" title="一、可用性的理解"></a>一、可用性的理解</h3><h4 id="1．理解目标"><a href="#1．理解目标" class="headerlink" title="1．理解目标"></a>1．理解目标</h4><p>业界高可用的目标是几个9，对于每一个系统的要求是不一样的，对研发人员来说，要对设计或者开发的系统知道其用户规模及使用场景，知道可用性的目标。<br>比如5个9的目标能分解：全年故障5分钟。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/99%E8%AF%B4%E6%98%8E.png" alt=""></p>
<h4 id="2．拆解目标"><a href="#2．拆解目标" class="headerlink" title="2．拆解目标"></a>2．拆解目标</h4><p>  几个9的目标比较抽象，需要对目标进行合理的分解，可以分解成如下两个子目标</p>
<h5 id="2-1-频率要低：减少出故障的次数。"><a href="#2-1-频率要低：减少出故障的次数。" class="headerlink" title="2.1 频率要低：减少出故障的次数。"></a>2.1 频率要低：减少出故障的次数。</h5><p>不出问题，一定是高可用的，但这是不可能的。系统越大、越复杂，只能尽量避免问题，通过系统设计，流程机制来减少这种问题概率。但如果经常出问题，后面的恢复再快也是没有用的。</p>
<h5 id="2-2-时间要快：故障恢复时间要快"><a href="#2-2-时间要快：故障恢复时间要快" class="headerlink" title="2.2 时间要快：故障恢复时间要快"></a>2.2 时间要快：故障恢复时间要快</h5><p>故障出现时，不是解决或者定位到具体问题，而是快速恢复是第一要务的，防止次生灾害，问题扩大。这里就要求要站在业务角度思考，而不仅是技术角度思考。</p>
<h3 id="二、频率要低：减少出故障的次数"><a href="#二、频率要低：减少出故障的次数" class="headerlink" title="二、频率要低：减少出故障的次数"></a>二、频率要低：减少出故障的次数</h3><h4 id="1．高可用性的设计：根据业务变化不断进行迭代。"><a href="#1．高可用性的设计：根据业务变化不断进行迭代。" class="headerlink" title="1．高可用性的设计：根据业务变化不断进行迭代。"></a>1．高可用性的设计：根据业务变化不断进行迭代。</h4><p>以点评交易系统的演进过程举例</p>
<p><strong>1）幼儿时期：2012</strong></p>
<p>使命：满足业务要求，快速上线。</p>
<p>2011年要快速的把团购产品推向市场，团队都是临时从各个团队抽取的人才，大部分对.net更熟悉，所以使用.net进行了第一代的团购系统设计，满足业务要求是第一的，还没有机会遇到可用性等质量问题。考虑比较简单，要挂都挂了，量也比较小，出现问题，重启，扩容，回滚就解决问题了。</p>
<p>系统长成下图这样：</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/2012%E5%B9%B4%E5%9B%A2%E8%B4%AD.png" alt=""></p>
<p>2）少年时期：垂直拆分（2012-2013)</p>
<p>使命：研发效率&amp;故障隔离<br>当2012年在团单量从千到万量级变化，用户每日的下单量也到了万级时候，需要考虑的是迭代速度，研发效率。所以要做小而美的团队。另外一方面也需要将各个业务相互隔离，比如商品首页的展示，商品详情页的展示，订单、支付流程的稳定性要求不一样。前面可以缓存，可以做静态化来保证可用性，提供一些柔性体验。后面支付系统做异地容灾，比如我们除了南汇机房支付系统，在宝山机房也部署了，只是后来发现这个系统演进太快，没有工具和机制保证双机房更新，所以后来也不好使用了。</p>
<p>系统演进成下图这样：这个就是服务垂直化了，但是数据没有完整隔离开，互相摸。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E6%9C%8D%E5%8A%A1%E5%8C%96.png" alt=""></p>
<p>3）青年时期：服务做小，不共享数据（2014-2015 ）</p>
<p>使命：支撑业务快速发展，提供高效、高可用的技术能力<br>从2013年开始，deal－service （商品系统）偶尔会因为某一次大流量（大促，常规活动）会挂，每几个月总有那么一次。基本上可用性就在3个9徘徊，这里订单和支付系统很稳定的，因为流量在商品详情页到订单有一个转化率，流量大了详情页就挂了，订单也就没有流量了，后来做了详情的静态化做得比较好了，能减少恢复的速度，能降级，但是deal-service的各个系统依赖太深了，还是不能保证整体端到端的可用性。</p>
<p>所以2014年deal-service就做了很大的重构，大系统做小，把商品详情系统拆成了无数小服务，比如库存服务，价格服务，基础数据服务等等。这下商品详情页的问题解决了，所以从2014年低订单系统的压力就来了，前面好了，后面压力就来了。2014年10月起，订单系统，支付系统也启动了全面微服务化，经过大约1年的实践，订单系统、促销系统、支付系统这3个领域后面的服务总和都快上百个了，后面对应的数据库20多个，这样能支撑到每日订单量百万级。</p>
<p>业务的增长在应用服务层面是可以扩容的，但是最大的单点，数据库是集中式的，这个阶段我们主要是把应用的数据访问在读写上分离，数据库提供更多的从库解决读的问题，但是写入仍然式最大的瓶颈（mysql的读可以扩展，写入QPS 也就小2万）。</p>
<p>系统演变成下图这样：这个架构大约能支撑QPS 3000左右的订单量。 </p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB.png" alt=""></p>
<p>4）成年时期：水平拆分（2015-现在）使命：</p>
<p>系统要能支撑大规模的促销活动，订单系统能支撑每秒几万的QPS，每日上千万的订单量。</p>
<p>2015年的917吃货节，流量最高峰，如果我们仍然是前面的技术架构，必然会挂掉，所以在917这个大促的前几个月，我们就在订单系统进行了架构升级，水平拆分，核心就是解决数据单点，把订单表拆分成了1024张表，分布在32个数据库，每个库32张表。这样能支撑到我们能看见到未来了。</p>
<p>虽然数据层的问题解决了，但是我们还是有些单点，我们用的MQ，网络，机房等。举几个曾经我过去遇到的不容易碰到的可用性问题：</p>
<p>1）服务的网卡有一个网卡坏了，没有被监测到，后来发现另一个网卡也坏了，这样服务就挂了。</p>
<p>2）我们使用 cache的时候发现可用性在高峰期非常低，后来发现这个cache服务器跟公司监控系统cat服务器在一个机柜，高峰期的流量被cat跑了一大半，给业务的网络流量就非常少，就影响了业务。</p>
<p>3）917大促的时候我们对MQ这个依赖的通道能力评估出现了偏差，也没有备份方案，所以造成了一小部分的延迟。</p>
<p>这个时期系统演进下图这样：</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E6%9C%8D%E5%8A%A1%E9%9A%94%E7%A6%BB%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB.png" alt=""></p>
<p>5）未来：思路仍然是大系统做小，基础通道做大，流量分块。</p>
<p>大系统做小，就是把复杂系统拆成单一职责系统，并从单机、主备、集群、异地等架构方向扩展。</p>
<p>基础通道做大就是把基础通信框架，带宽等高速路做大。</p>
<p>流量分块就是把用户流量按照某种模型拆分，让他们聚合在某一个服务集群完成，闭环解决。</p>
<p>系统可能会演变下下图这样：</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E9%80%9A%E9%81%93%E9%9A%94%E7%A6%BB.png" alt=""></p>
<p>上面点评交易系统的发展几个阶段，只以业务系统的演进为例，除了这些还有CDN，DNS、网络、机房等各个时期遇到的不同的可用性问题，我们遇到过的问题，比如：联通的网络挂了，需要切换到电信；比如数据库的电源被人踢掉了。</p>
<h4 id="2．易运营"><a href="#2．易运营" class="headerlink" title="2．易运营"></a>2．易运营</h4><p>高可用性的系统一定是可运营的，听到运营，大家更多的想到的是产品运营，其实技术的运营指的是线上的质量，流程能否运营，比如，整个系统上线后，是否方便切换流量，是否方便开关，是否方便扩展。这里有几个基本要求：<br>1）可限流<br>线上的流量永远有想不到的情况，在这种情况下，系统的稳定吞吐能力就非常重要了，高并发的系统一般采取的策略是快速失败机制，比如系统QPS能支撑5000，但是1万的流量过来，我能保证持续的5000，其他5000我快速失败，这样很快1万的流量就被消化掉了。比如917的支付系统就是采取了流量限制，如果超过某一个流量峰值，我们就自动返回请稍后再试等。<br>2）无状态<br>应用系统要完全无状态，运维才能随便扩容，分配流量。<br>3）降级能力<br>降级能力是跟产品一起来看的，需要看降级后，对用户的体验的影响，简单的比如，提示语是什么，比如我们支付渠道，如果支付宝渠道挂了，我们挂了50% ，我们支付宝的渠道是旁会自动出现一个提示，这个渠道可能不稳定，但是可以点击；当支付宝渠道挂了100% ，我们的按钮是灰色的，不能点击。也会有提示，比如换其他支付渠道（刚刚微信支付还挂了，就又起作用了）。另一个案例，我们在啊917大促的时候对某些依赖方，比如诚信的校验，这种如果判断比较耗资源，又可控的情况下，可以通过开关直接关闭或者启用。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E5%AE%9E%E4%BE%8B.png" alt=""></p>
<h4 id="3．可测试"><a href="#3．可测试" class="headerlink" title="3．可测试"></a>3．可测试</h4><p>无论架构多么完美，验证这一步必不可少，系统的可测试行就非常重要。<br>测试的目的要先预估流量的大小，比如某次大促，要跟产品、运营讨论流量的来源，活动的力度，每一张页面的，每一个按钮的位置，进行较准确的预估。<br>再测试集群的能力，有很多同学在实施的时候总喜欢测试单台，然后水平放大，给一个结论，但这不是很准确，要分析所有的流量是否在系统间流转时候的比例。尤其对流量模型的测试（要注意高峰流量模型跟平常流量模型可能不一致的）系统架构的容量测试，比如我们某一次大促的测试方法<br>从上到下评估流量，从下至上评估能力：发现一次订单提交 有20次数据库访问，读写比例高峰期是1:1，然后就跟进数据库的能力倒推系统应该放入的流量，然后做好前端的异步下单，让整个流量平缓的下放到数据库。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E6%B5%81%E9%87%8F%E8%AF%84%E4%BC%B0.png" alt=""></p>
<h4 id="4-降低发布风险"><a href="#4-降低发布风险" class="headerlink" title="4.  降低发布风险"></a>4.  降低发布风险</h4><p>4.1 严格的发布流程</p>
<p>目前点评的发布都是开发自己负责的，通过平台自己完成的，上线的流程，发布的常规流程模版：</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>4.2  灰度机制</p>
<p>1）服务器发布是分批，按照10%，30%，50%，100%的发布，开发通过观察监控系统的曲线，及系统的日志确定业务是否正常。<br>2）线上的流量灰度机制，重要功能上线能有按照某种流量灰度上线能力。<br>3）可回滚是标配，最好有最坏情况的预案。</p>
<h3 id="三、时间要快：故障恢复时间要快"><a href="#三、时间要快：故障恢复时间要快" class="headerlink" title="三、时间要快：故障恢复时间要快"></a>三、时间要快：故障恢复时间要快</h3><p>如果目标就要保证全年不出故障或者出了故障在5分钟之内能解决，要对5分钟进行充分的使用，对5分钟的拆解：1分钟发现故障，3分钟定位故障出现在哪个服务，再加上后面的恢复时间。就是整个时间的分解，目前我们系统大致能做到前面2步，离整体5个9的目标还有差距，因为恢复的速度跟架构的设计，信息在开发、运维、DBA之间的沟通速度及工具能力，及处理问题人员的本身能力有关。<br>生命值：</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt=""></p>
<p>1．持续关注线上运行情况<br>1）熟悉并感知系统变化，要快就要熟，孰能生巧，所以要关注线上运营情况。<br>对应用所在的网络、服务器性能、存储、数据库等系统指标了解。<br>能监控应用的执行状态、对应用的自己QPS、响应时间、可用性指标，并对依赖的上下游的流量情况同样熟悉。<br>2）保证系统稳定吞吐  ：系统如果能做好流量控制，容错，保证一个稳定的吞吐，能保证大部分场景的可用，也能很快的消化高峰流量，避免出现故障，产生流量的多次高峰。<br>2．故障时<br>2.1．快速的发现机制<br>1）告警的移动化  ：系统可用性的告警应该全部用微信、短信这种能保证找到人的通信机制。<br>1）告警的实时化：目前我们只能做到1分钟左右告警。<br>3）监控的可视化：我们的系统目前的要求是1分钟发现故障，3分钟定位故障：这就需要做好监控的可视化，在所有关键service里面的方法层面打点，然后做成监控曲线，不然3分钟定位到具体是那个地方出问题，比较困难。点评的监控系统cat能很好的提供这些指标变化，我们系统再这些基础上也做了一些更实时的能力，比如订单系统的我们的QPS 就是开发的秒级的监控曲线。</p>
<p><img src="http://7xkbey.com1.z0.glb.clouddn.com/%E5%8F%AF%E8%A7%86%E5%8C%96%E7%9B%91%E6%8E%A7.png" alt=""></p>
<p>2.2．有效的恢复机制</p>
<p>比如运维的四板斧：回滚、重启、扩容、下服务器。在系统不是很复杂，流量不是很高的情况下，这能解决问题，当大流量的时候这个就很难解决了，所以更多的从流量控制、降级体验方面下功夫</p>
<h3 id="四、几点经验"><a href="#四、几点经验" class="headerlink" title="四、几点经验"></a>四、几点经验</h3><p>1．珍惜每次真实高峰流量，建立高峰期流量模型。<br>2．珍惜每次线上故障复盘，上一层楼看问题，下一楼解决问题。<br>3．可用性不只是技术问题<br>系统初期是：以开发为主；<br>系统中期是：开发＋DBA＋运维为主；<br>系统后期是：技术＋产品＋运维＋DBA ；<br>4．单点和发布是可用性最大的敌人</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/undefined/" data-id="cipak3m43000oya5nhybnvx49" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/转载/">转载</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016新年计划" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/2016-newyear-plan/" class="article-date">
  <time datetime="2016-01-10T07:51:00.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/post/2016-newyear-plan/">2016新年计划</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>2015年写了一次新年计划，今天继续吧。<br>先来看看2015年做的怎么样了。</p>
<h3 id="2015年完成了什么"><a href="#2015年完成了什么" class="headerlink" title="2015年完成了什么"></a>2015年完成了什么</h3><p><a href="/post/2015-newyear-plan">2015新年计划</a> 写了5件事情。</p>
<ul>
<li><p>一个月读一本书</p>
<p>  这个已经完成了，只是没有一本本记录过，今年做下记录。<br>  完成度：★★★★★</p>
</li>
<li><p>出去旅游一次</p>
<p>  今年旅游了两次，一次是五一去<a href="http://www.dianping.com/shop/4501452" target="_blank" rel="external">半山温泉</a>做了下自驾游，还有就是最近<a href="https://www.instagram.com/brucefeng/" target="_blank" rel="external">台湾游</a>。<br>完成度：★★★★★</p>
</li>
<li>学习一门新的编程语言<br>之前一直学习Clojure，可惜学了好久的语法，到最后也不想继续再坚持写项目了。现在开始学Golang了，不过进展也不大。这个任务完成的不好<br>完成度：★★☆☆☆</li>
<li>研究一个开源项目<br>今年学习变成语言的时候断断续续的研究了许多项目，但是一直没能深入下去一个，更没有参与到其中了。完成的也不够好。<br>完成度：★★☆☆☆</li>
<li>工作上再升级<br>今天在工作上成长了许多，包括自己的设计能力，业务项目的架构能力和技术管理的能力。至于级别能不能升已经不在意了，更重要的是自己的成长。<br>完成度：★★★★★</li>
</ul>
<h3 id="2016年要做什么"><a href="#2016年要做什么" class="headerlink" title="2016年要做什么"></a>2016年要做什么</h3><h4 id="1-读书计划"><a href="#1-读书计划" class="headerlink" title="1. 读书计划"></a>1. 读书计划</h4><p>继续每月一本书。<br>几年要少看点小说，多看些社会历史、投资理财的书籍。</p>
<h4 id="2-学会英语"><a href="#2-学会英语" class="headerlink" title="2. 学会英语"></a>2. 学会英语</h4><p>每年学会一个语言，今年学习英语。</p>
<p>英语一直没有学会，今年达到英语熟练读写说的程度。</p>
<h4 id="3-个人成长"><a href="#3-个人成长" class="headerlink" title="3. 个人成长"></a>3. 个人成长</h4><p>变得平和。</p>
<p>30岁了，对人对事需要更成熟些，遇到事情不能再像以前那样急躁了，变得平和些，遇事稳重些。</p>
<h4 id="4-工作上转变为管理者"><a href="#4-工作上转变为管理者" class="headerlink" title="4. 工作上转变为管理者"></a>4. 工作上转变为管理者</h4><p>一直拒绝变成管理者，在工作上还是更想做一个技术人员；单现实工作却越来越要求自己转变为一个技术管理者，以前的想法导致自己难以胜任现在的工作，使得大家都别扭。<br>新的一年，自己彻底转变成技术管理者，在打磨技术的同时让自己的管理能力更上一层楼。</p>
<h4 id="5-凡事多思考"><a href="#5-凡事多思考" class="headerlink" title="5. 凡事多思考"></a>5. 凡事多思考</h4><p>在工作中、生活中遇到一些问题和新事物都认真思考，考虑清楚再来做决定。</p>
<p>怎么才叫思考清楚呢？就是当自己想要说服别人的时候，别人提过的问题自己都能回答，至少自己都思考到了。</p>
<p>今年也是五条计划，再接再厉。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/2016-newyear-plan/" data-id="cipak1vor0001y95nm9o1vrwi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/新年计划/">新年计划</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-网站开发动静分离实践.comments" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/undefined/" class="article-date">
  <time datetime="2016-01-10T07:50:39.000Z" itemprop="datePublished">2016-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>date: 2015-12-14 14:23:11<br>author: 在线工具<br>email: wzwahl36@qq.com<br>site: <a href="http://www.atool.org/" target="_blank" rel="external">http://www.atool.org/</a><br>ip: 123.58.191.68</p>
<p>可以加一些东西，比如：对于有已经有的没有动静分离的网站，如何快速动静分离~</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/post/undefined/" data-id="cipak1vs7001ny95nlmg5ryq6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/clojure/">clojure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/programing/">programing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/summarize/">summarize</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术总结/">技术总结</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Clojure/">Clojure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Clojure-ruleengine/">Clojure ruleengine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Idempotent/">Idempotent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-JVM/">Java JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL-Index-SQL/">MySQL Index SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL-MySQL/">SQL MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Java/">Spring Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Undertow/">Undertow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clojure-Compojure/">clojure Compojure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/front-end-cross-domian/">front-end, cross-domian</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memcached/">memcached</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice/">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice-design-patterns/">microservice design-patterns</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rime-输入法/">rime,输入法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpc-pigeon/">rpc pigeon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrum-敏捷-大项目管理/">scrum 敏捷 大项目管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动态代码-Groovy-OGNL-SpEL-MVEL/">动态代码 Groovy OGNL SpEL MVEL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动静分离/">动静分离</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/实时通信-comet-websocket/">实时通信 comet websocket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术总结/">技术总结</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/新年计划/">新年计划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/管理/">管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统重构-设计模式/">系统重构 设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/转载/">转载</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Clojure/" style="font-size: 20px;">Clojure</a> <a href="/tags/Clojure-ruleengine/" style="font-size: 10px;">Clojure ruleengine</a> <a href="/tags/Idempotent/" style="font-size: 10px;">Idempotent</a> <a href="/tags/Java-JVM/" style="font-size: 10px;">Java JVM</a> <a href="/tags/MySQL-Index-SQL/" style="font-size: 10px;">MySQL Index SQL</a> <a href="/tags/SQL-MySQL/" style="font-size: 10px;">SQL MySQL</a> <a href="/tags/Spring-Java/" style="font-size: 16.67px;">Spring Java</a> <a href="/tags/Undertow/" style="font-size: 13.33px;">Undertow</a> <a href="/tags/clojure-Compojure/" style="font-size: 10px;">clojure Compojure</a> <a href="/tags/front-end-cross-domian/" style="font-size: 10px;">front-end, cross-domian</a> <a href="/tags/memcached/" style="font-size: 10px;">memcached</a> <a href="/tags/microservice/" style="font-size: 10px;">microservice</a> <a href="/tags/microservice-design-patterns/" style="font-size: 10px;">microservice design-patterns</a> <a href="/tags/rime-输入法/" style="font-size: 10px;">rime,输入法</a> <a href="/tags/rpc-pigeon/" style="font-size: 10px;">rpc pigeon</a> <a href="/tags/scrum-敏捷-大项目管理/" style="font-size: 10px;">scrum 敏捷 大项目管理</a> <a href="/tags/动态代码-Groovy-OGNL-SpEL-MVEL/" style="font-size: 10px;">动态代码 Groovy OGNL SpEL MVEL</a> <a href="/tags/动静分离/" style="font-size: 10px;">动静分离</a> <a href="/tags/实时通信-comet-websocket/" style="font-size: 10px;">实时通信 comet websocket</a> <a href="/tags/技术总结/" style="font-size: 16.67px;">技术总结</a> <a href="/tags/新年计划/" style="font-size: 13.33px;">新年计划</a> <a href="/tags/管理/" style="font-size: 13.33px;">管理</a> <a href="/tags/系统重构-设计模式/" style="font-size: 10px;">系统重构 设计模式</a> <a href="/tags/转载/" style="font-size: 10px;">转载</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">九月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/post/bigproj-in-scrum/">Scrum中大项目管理</a>
          </li>
        
          <li>
            <a href="/post/dynamic-code-in-java/">Java中使用动态代码</a>
          </li>
        
          <li>
            <a href="/post/system-reconstruct-summary/">业务系统重构总结</a>
          </li>
        
          <li>
            <a href="/post/service-design-patterns-practices/">服务化设计模式实践</a>
          </li>
        
          <li>
            <a href="/post/brower-server-msg/">浏览器与服务器的消息通信</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 陈景广<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>